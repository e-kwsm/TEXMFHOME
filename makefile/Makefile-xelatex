builddir     := .build
XELATEX      := xelatex \
  -halt-on-error -interaction=nonstopmode -file-line-error \
  -output-directory=$(builddir)
tex          :=
pdf          := $(tex:.tex=.pdf)
bibdir       := ref
bibfile      := bibfile.bib
biber_option := --output-directory=$(builddir)
tar_exclude  := $(builddir)
TAR          := tar $(addprefix --exclude , $(tar_exclude)) -acf
archive      := $(notdir $(realpath .)).tgz
remdir       := ~/Dropbox/

.PHONY: protect
#protect:;:

.PHONY: once
once: | $(builddir)
	$(XELATEX) -no-pdf $(tex)
	xdvipdfmx $(builddir)/$(tex:.tex=.xdv)

.PHONY: bib
bib: $(builddir)/$(tex:.tex=.bbl)
	$(XELATEX) -no-pdf $(tex) > /dev/null
	xdvipdfmx $(builddir)/$(tex:.tex=.xdv)

$(builddir)/$(tex:.tex=.bbl): $(builddir)/$(tex:.tex=.bcf) $(bibfile)
	biber $(biber_option) $(notdir $<) || { rm -f $< $@; exit 1; }

$(builddir)/$(tex:.tex=.bcf): | $(builddir)
	$(XELATEX) -no-pdf $(tex) || { rm -f $(builddir)/$(tex:.tex=.bbl); exit 1; }

$(bibfile): $(wildcard $(bibdir)/*.bib)
	echo $(sort $^) | xargs cat > $@

$(builddir):
	mkdir -p $@

.PHONY: all
all: pdf

.PHONY: pdf
pdf: once bib

$(pdf): pdf

.PHONY: clean
clean:
	rm -rf $(builddir)

.PHONY: distclean
distclean: clean
	rm -f $(bibfile)
	rm -f $(pdf)

.PHONY: view
view:
	xdg-open $(pdf) &

.PHONY: backup
backup:
	$(TAR) /tmp/$(archive) ../$(notdir $(realpath .))
	rsync -av --remove-source-files /tmp/$(archive) $(remdir)
